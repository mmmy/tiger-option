<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deltaç®¡ç†å™¨ - TigeræœŸæƒäº¤æ˜“</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ…</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ…</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .account-selector {
            margin: 20px 0;
        }

        .account-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ff7b00;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(255, 123, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ff7b00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #333;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #fff3e0;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #ff7b00;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-info {
            background: #ff7b00;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .delta-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .delta-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .action-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-buy {
            background: #27ae60;
            color: white;
        }

        .action-sell {
            background: #e74c3c;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ff7b00;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 123, 0, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #ff9500;
        }

        #copyAlertBtn {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 123, 0, 0.3);
        }

        #copyAlertBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 123, 0, 0.4);
            background: linear-gradient(135deg, #e66a00 0%, #e68500 100%);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- å¼•å…¥ axios åº“ -->
    <script>
        const cdnUrls = [
            'https://unpkg.com/axios@1.6.0/dist/axios.min.js',
            'https://cdn.bootcdn.net/ajax/libs/axios/1.6.0/axios.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js'
        ];

        let currentCdnIndex = 0;

        function loadAxios() {
            if (currentCdnIndex >= cdnUrls.length) {
                console.error('æ‰€æœ‰ axios CDN éƒ½åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨ fetch ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
                return;
            }

            const script = document.createElement('script');
            script.src = cdnUrls[currentCdnIndex];
            script.onload = function() {
                console.log(`axios åŠ è½½æˆåŠŸï¼Œä½¿ç”¨ CDN: ${cdnUrls[currentCdnIndex]}`);
            };
            script.onerror = function() {
                console.warn(`CDN åŠ è½½å¤±è´¥: ${cdnUrls[currentCdnIndex]}`);
                currentCdnIndex++;
                loadAxios();
            };
            document.head.appendChild(script);
        }

        loadAxios();
    </script>

    <div class="container">
        <div class="header">
            <h1>ğŸ… Deltaç®¡ç†å™¨</h1>
            <p>TigeræœŸæƒä»“ä½å’Œè®¢å•Deltaç®¡ç†</p>

            <div class="account-selector">
                <label for="accountSelect" style="margin-right: 10px;">é€‰æ‹©è´¦æˆ·:</label>
                <select id="accountSelect">
                    <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                </select>

                <button id="copyAlertBtn" class="btn btn-info" style="margin-left: 20px;" title="å¤åˆ¶TradingViewè­¦æŠ¥æ¶ˆæ¯æ¨¡æ¿">
                    ğŸ“‹ å¤åˆ¶è­¦æŠ¥æ¶ˆæ¯
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="loadingMessage" class="loading">
                <h3>ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</h3>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="successMessage" class="success" style="display: none;"></div>

            <div id="mainContent" style="display: none;">
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æ€»Delta</h3>
                        <div class="value" id="totalDelta">0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>ä»“ä½Delta</h3>
                        <div class="value" id="positionDelta">0.00</div>
                        <div class="stat-subtitle" id="positionCount">0ä¸ªä»“ä½</div>
                    </div>
                    <div class="stat-card">
                        <h3>è®¢å•æ•°é‡</h3>
                        <div class="value" id="orderCount">0</div>
                        <div class="stat-subtitle">è®¢å•æ— Deltaå€¼</div>
                    </div>
                    <div class="stat-card">
                        <h3>è´¦æˆ·ä½™é¢</h3>
                        <div class="value" id="accountBalance">$0.00</div>
                        <div class="stat-subtitle" id="availableFunds">å¯ç”¨: $0.00</div>
                    </div>
                </div>

                <!-- å®é™…ä»“ä½ -->
                <div class="section">
                    <div class="section-title">
                        ğŸ¦ å®é™…æœŸæƒä»“ä½
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-positions" id="refreshPositionsBtn">
                                ğŸ”„ åˆ·æ–°ä»“ä½
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionsTable">
                            <thead>
                                <tr>
                                    <th>æœŸæƒåˆçº¦</th>
                                    <th>æ ‡çš„</th>
                                    <th>ç±»å‹</th>
                                    <th>è¡Œæƒä»·</th>
                                    <th>åˆ°æœŸæ—¥</th>
                                    <th>æ•°é‡</th>
                                    <th>å¹³å‡ä»·æ ¼</th>
                                    <th>å½“å‰ä»·æ ¼</th>
                                    <th>Deltaå€¼</th>
                                    <th>ç›ˆäº</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- æœªæˆäº¤è®¢å• -->
                <div class="section">
                    <div class="section-title">
                        ğŸ“‹ æœªæˆäº¤æœŸæƒè®¢å•
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-orders" id="refreshOrdersBtn">
                                ğŸ”„ åˆ·æ–°è®¢å•
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>è®¢å•ID</th>
                                    <th>æœŸæƒåˆçº¦</th>
                                    <th>æ ‡çš„</th>
                                    <th>ç±»å‹</th>
                                    <th>æ–¹å‘</th>
                                    <th>æ•°é‡</th>
                                    <th>ä»·æ ¼</th>
                                    <th>è®¢å•ç±»å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- äº¤æ˜“è®°å½• -->
                <div class="section">
                    <div class="section-title">
                        ğŸ“Š æœ€è¿‘äº¤æ˜“è®°å½•
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-trades" id="refreshTradesBtn">
                                ğŸ”„ åˆ·æ–°è®°å½•
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tradesTable">
                            <thead>
                                <tr>
                                    <th>äº¤æ˜“æ—¶é—´</th>
                                    <th>æœŸæƒåˆçº¦</th>
                                    <th>æ ‡çš„</th>
                                    <th>æ–¹å‘</th>
                                    <th>æ•°é‡</th>
                                    <th>æˆäº¤ä»·æ ¼</th>
                                    <th>æ‰‹ç»­è´¹</th>
                                    <th>ç›ˆäº</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" data-action="load-data" title="åˆ·æ–°æ•°æ®">
        ğŸ”„
    </button>

    <script>
        // åˆ›å»ºç»Ÿä¸€çš„ HTTP å®¢æˆ·ç«¯
        const httpClient = {
            async get(url) {
                if (typeof axios !== 'undefined') {
                    return await axios.get(url);
                } else {
                    console.warn('axios æœªåŠ è½½ï¼Œä½¿ç”¨ fetch å¤‡ç”¨æ–¹æ¡ˆ');
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async post(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.post(url, data);
                } else {
                    console.warn('axios æœªåŠ è½½ï¼Œä½¿ç”¨ fetch å¤‡ç”¨æ–¹æ¡ˆ');
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            }
        };

        // é…ç½®axios
        setTimeout(() => {
            if (typeof axios !== 'undefined') {
                axios.defaults.timeout = 30000;
                axios.defaults.headers.common['Content-Type'] = 'application/json';

                axios.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response) {
                            let message = error.response.data?.message || `HTTP ${error.response.status}: ${error.response.statusText}`;
                            if (error.response.status === 404 && message.includes('Account not found')) {
                                const accountName = message.split(': ')[1];
                                message = `è´¦æˆ· "${accountName}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`;
                            }
                            throw new Error(message);
                        } else if (error.request) {
                            throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€');
                        } else {
                            throw new Error(error.message);
                        }
                    }
                );
                console.log('axios é…ç½®å®Œæˆ');
            }
        }, 1000);

        // å…¨å±€å˜é‡
        let currentAccount = '';
        let positions = [];
        let orders = [];
        let trades = [];
        let availableAccounts = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading('æ­£åœ¨åˆå§‹åŒ–è´¦æˆ·åˆ—è¡¨...');
            await loadAccounts();

            // ä»URLå‚æ•°è·å–è´¦æˆ·ID
            const urlParams = new URLSearchParams(window.location.search);
            const accountId = urlParams.get('account');
            if (accountId) {
                if (availableAccounts.length > 0 && availableAccounts.includes(accountId)) {
                    document.getElementById('accountSelect').value = accountId;
                    selectAccount(accountId);
                } else if (availableAccounts.length > 0) {
                    showError(`URLä¸­æŒ‡å®šçš„è´¦æˆ· "${accountId}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`);
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                } else {
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                }
            }

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                    e.preventDefault();
                    if (currentAccount) {
                        loadData();
                    }
                }
            });

            // ç»Ÿä¸€çš„äº‹ä»¶å§”æ‰˜å¤„ç†å™¨
            document.addEventListener('click', function(e) {
                const target = e.target;
                const action = target.getAttribute('data-action');

                if (!action) return;

                console.log('ğŸ¯ æ£€æµ‹åˆ°æŒ‰é’®ç‚¹å‡»:', action);

                try {
                    switch (action) {
                        case 'refresh-positions':
                            refreshPositions();
                            break;
                        case 'refresh-orders':
                            refreshOrders();
                            break;
                        case 'refresh-trades':
                            refreshTrades();
                            break;
                        case 'load-data':
                            loadData();
                            break;
                        case 'cancel-order':
                            const orderId = target.getAttribute('data-order-id');
                            cancelOrder(orderId);
                            break;
                        case 'close-position':
                            const symbol = target.getAttribute('data-symbol');
                            closePosition(symbol);
                            break;
                        default:
                            console.log('âš ï¸ æœªçŸ¥çš„æ“ä½œ:', action);
                    }
                } catch (error) {
                    console.error('âŒ æ‰§è¡Œæ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥: ' + error.message);
                }
            });

            // ç»‘å®šå¤åˆ¶è­¦æŠ¥æ¶ˆæ¯æŒ‰é’®
            const copyAlertBtn = document.getElementById('copyAlertBtn');
            if (copyAlertBtn) {
                copyAlertBtn.addEventListener('click', showAlertModal);
            }
        });

        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await httpClient.get('/api/accounts');
                const data = response.data;

                if (data.success && data.data && Array.isArray(data.data)) {
                    availableAccounts = data.data.map(acc => acc.name || acc);
                    console.log(`ğŸ“‹ ä»APIè·å–åˆ° ${availableAccounts.length} ä¸ªè´¦æˆ·:`, availableAccounts);
                } else {
                    console.warn('APIæœªè¿”å›accountså­—æ®µï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    availableAccounts = [];
                }

                const select = document.getElementById('accountSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>';

                if (availableAccounts.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'âš ï¸ æœªæ‰¾åˆ°å¯ç”¨è´¦æˆ·';
                    option.disabled = true;
                    select.appendChild(option);
                    showError('æœªæ‰¾åˆ°å¯ç”¨è´¦æˆ·ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®');
                } else {
                    availableAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                }

                select.addEventListener('change', function() {
                    if (this.value) {
                        selectAccount(this.value);
                        const url = new URL(window.location);
                        url.searchParams.set('account', this.value);
                        window.history.pushState({}, '', url);
                    }
                });

            } catch (error) {
                showError('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
            } finally {
                if (!currentAccount) {
                    hideLoading();
                }
            }
        }

        // é€‰æ‹©è´¦æˆ·
        function selectAccount(accountId) {
            if (!availableAccounts.includes(accountId)) {
                showError(`è´¦æˆ· "${accountId}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`);
                const url = new URL(window.location);
                url.searchParams.delete('account');
                window.history.replaceState({}, '', url);
                document.getElementById('accountSelect').value = '';
                return;
            }

            currentAccount = accountId;
            loadData();
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            showLoading();

            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [accountResponse, positionsResponse, ordersResponse, tradesResponse] = await Promise.all([
                    httpClient.get(`/api/accounts/${currentAccount}/summary`),
                    httpClient.get(`/api/accounts/${currentAccount}/positions`),
                    httpClient.get(`/api/accounts/${currentAccount}/orders`),
                    httpClient.get(`/api/accounts/${currentAccount}/trades`)
                ]);

                // æ›´æ–°æ•°æ®
                const accountData = accountResponse.data;
                const positionsData = positionsResponse.data;
                const ordersData = ordersResponse.data;
                const tradesData = tradesResponse.data;

                if (accountData.success) {
                    updateAccountStats(accountData.data);
                }

                if (positionsData.success) {
                    positions = positionsData.data || [];
                    updatePositionsTable();
                }

                if (ordersData.success) {
                    orders = ordersData.data || [];
                    updateOrdersTable();
                }

                if (tradesData.success) {
                    trades = tradesData.data || [];
                    updateTradesTable();
                }

                hideLoading();
                showSuccess('æ•°æ®åŠ è½½æˆåŠŸ');

            } catch (error) {
                hideLoading();
                showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°è´¦æˆ·ç»Ÿè®¡ä¿¡æ¯
        function updateAccountStats(accountData) {
            const totalDelta = accountData.total_delta || 0;
            const positionDelta = accountData.position_delta || 0;
            const orderCount = orders.length;
            const balance = accountData.net_liquidation || accountData.total_cash || 0;
            const availableFunds = accountData.available_funds || accountData.buying_power || 0;

            document.getElementById('totalDelta').textContent = totalDelta.toFixed(4);
            document.getElementById('positionDelta').textContent = positionDelta.toFixed(4);
            document.getElementById('orderCount').textContent = orderCount;
            document.getElementById('accountBalance').textContent = `$${balance.toLocaleString()}`;
            document.getElementById('availableFunds').textContent = `å¯ç”¨: $${availableFunds.toLocaleString()}`;

            document.getElementById('positionCount').textContent = `${positions.length}ä¸ªä»“ä½`;

            // è®¾ç½®Deltaé¢œè‰²
            const totalElement = document.getElementById('totalDelta');
            const positionElement = document.getElementById('positionDelta');

            totalElement.className = totalDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
            positionElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
        }

        // æ›´æ–°ä»“ä½è¡¨æ ¼
        function updatePositionsTable() {
            const tbody = document.querySelector('#positionsTable tbody');
            tbody.innerHTML = '';

            positions.forEach(position => {
                const row = document.createElement('tr');

                // è§£ææœŸæƒä¿¡æ¯
                const symbol = position.symbol || position.contract || '';
                const underlying = position.underlying || extractUnderlying(symbol);
                const optionType = position.option_type || extractOptionType(symbol);
                const strike = position.strike || extractStrike(symbol);
                const expiry = position.expiry || extractExpiry(symbol);
                const quantity = position.quantity || position.position || 0;
                const avgPrice = position.average_price || position.avg_price || 0;
                const currentPrice = position.market_price || position.last_price || 0;
                const delta = position.delta || 0;
                const pnl = position.unrealized_pnl || position.pnl || 0;

                row.innerHTML = `
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${optionType === 'call' ? 'action-buy' : 'action-sell'}">${optionType.toUpperCase()}</span></td>
                    <td>$${strike}</td>
                    <td>${formatDate(expiry)}</td>
                    <td>${quantity}</td>
                    <td>$${avgPrice.toFixed(2)}</td>
                    <td>$${currentPrice.toFixed(2)}</td>
                    <td class="${delta >= 0 ? 'delta-positive' : 'delta-negative'}">${delta.toFixed(4)}</td>
                    <td class="${pnl >= 0 ? 'delta-positive' : 'delta-negative'}">$${pnl.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger" data-action="close-position" data-symbol="${symbol}">å¹³ä»“</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (positions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="11" style="text-align: center; color: #7f8c8d;">æš‚æ— æœŸæƒä»“ä½</td>';
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°è®¢å•è¡¨æ ¼
        function updateOrdersTable() {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            orders.forEach(order => {
                const row = document.createElement('tr');

                const orderId = order.order_id || order.id || '';
                const symbol = order.symbol || order.contract || '';
                const underlying = order.underlying || extractUnderlying(symbol);
                const optionType = order.option_type || extractOptionType(symbol);
                const side = order.side || order.action || '';
                const quantity = order.quantity || order.total_quantity || 0;
                const price = order.limit_price || order.price || 0;
                const orderType = order.order_type || order.type || '';
                const status = order.status || order.order_status || '';
                const createTime = order.create_time || order.created_at || '';

                row.innerHTML = `
                    <td>${orderId}</td>
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${optionType === 'call' ? 'action-buy' : 'action-sell'}">${optionType.toUpperCase()}</span></td>
                    <td><span class="action-badge ${side === 'buy' ? 'action-buy' : 'action-sell'}">${side.toUpperCase()}</span></td>
                    <td>${quantity}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>${orderType}</td>
                    <td>${status}</td>
                    <td>${formatDateTime(createTime)}</td>
                    <td>
                        <button class="btn btn-danger" data-action="cancel-order" data-order-id="${orderId}">æ’¤å•</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (orders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="11" style="text-align: center; color: #7f8c8d;">æš‚æ— æœªæˆäº¤è®¢å•</td>';
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°äº¤æ˜“è®°å½•è¡¨æ ¼
        function updateTradesTable() {
            const tbody = document.querySelector('#tradesTable tbody');
            tbody.innerHTML = '';

            trades.slice(0, 20).forEach(trade => { // åªæ˜¾ç¤ºæœ€è¿‘20æ¡è®°å½•
                const row = document.createElement('tr');

                const tradeTime = trade.trade_time || trade.created_at || '';
                const symbol = trade.symbol || trade.contract || '';
                const underlying = trade.underlying || extractUnderlying(symbol);
                const side = trade.side || trade.action || '';
                const quantity = trade.quantity || trade.filled_quantity || 0;
                const price = trade.price || trade.fill_price || 0;
                const commission = trade.commission || trade.fee || 0;
                const pnl = trade.realized_pnl || trade.pnl || 0;

                row.innerHTML = `
                    <td>${formatDateTime(tradeTime)}</td>
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${side === 'buy' ? 'action-buy' : 'action-sell'}">${side.toUpperCase()}</span></td>
                    <td>${quantity}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>$${commission.toFixed(2)}</td>
                    <td class="${pnl >= 0 ? 'delta-positive' : 'delta-negative'}">$${pnl.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            if (trades.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #7f8c8d;">æš‚æ— äº¤æ˜“è®°å½•</td>';
                tbody.appendChild(row);
            }
        }

        // åˆ·æ–°ä»“ä½
        async function refreshPositions() {
            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            const btn = document.getElementById('refreshPositionsBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/positions`);
                if (response.data.success) {
                    positions = response.data.data || [];
                    updatePositionsTable();
                    showSuccess(`ä»“ä½æ•°æ®åˆ·æ–°æˆåŠŸ - ${positions.length}ä¸ªä»“ä½`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('åˆ·æ–°ä»“ä½å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ åˆ·æ–°ä»“ä½';
            }
        }

        // åˆ·æ–°è®¢å•
        async function refreshOrders() {
            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            const btn = document.getElementById('refreshOrdersBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/orders`);
                if (response.data.success) {
                    orders = response.data.data || [];
                    updateOrdersTable();
                    showSuccess(`è®¢å•æ•°æ®åˆ·æ–°æˆåŠŸ - ${orders.length}ä¸ªè®¢å•`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('åˆ·æ–°è®¢å•å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ åˆ·æ–°è®¢å•';
            }
        }

        // åˆ·æ–°äº¤æ˜“è®°å½•
        async function refreshTrades() {
            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            const btn = document.getElementById('refreshTradesBtn');
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/trades`);
                if (response.data.success) {
                    trades = response.data.data || [];
                    updateTradesTable();
                    showSuccess(`äº¤æ˜“è®°å½•åˆ·æ–°æˆåŠŸ - ${trades.length}æ¡è®°å½•`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('åˆ·æ–°äº¤æ˜“è®°å½•å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ åˆ·æ–°è®°å½•';
            }
        }

        // æ’¤é”€è®¢å•
        async function cancelOrder(orderId) {
            if (!confirm(`ç¡®å®šè¦æ’¤é”€è®¢å• ${orderId} å—ï¼Ÿ`)) return;

            try {
                const response = await httpClient.post(`/api/accounts/${currentAccount}/orders/${orderId}/cancel`);
                if (response.data.success) {
                    showSuccess('è®¢å•æ’¤é”€æˆåŠŸ');
                    refreshOrders();
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('æ’¤é”€è®¢å•å¤±è´¥: ' + error.message);
            }
        }

        // å¹³ä»“
        async function closePosition(symbol) {
            if (!confirm(`ç¡®å®šè¦å¹³ä»“ ${symbol} å—ï¼Ÿ`)) return;

            try {
                const response = await httpClient.post(`/api/accounts/${currentAccount}/positions/${symbol}/close`);
                if (response.data.success) {
                    showSuccess('å¹³ä»“æ“ä½œæˆåŠŸ');
                    refreshPositions();
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('å¹³ä»“æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function extractUnderlying(symbol) {
            // ä»æœŸæƒåˆçº¦ç¬¦å·ä¸­æå–æ ‡çš„èµ„äº§
            if (!symbol) return '';
            const match = symbol.match(/^([A-Z]+)/);
            return match ? match[1] : symbol.split(' ')[0] || '';
        }

        function extractOptionType(symbol) {
            // ä»æœŸæƒåˆçº¦ç¬¦å·ä¸­æå–æœŸæƒç±»å‹
            if (!symbol) return '';
            return symbol.includes('C') || symbol.toLowerCase().includes('call') ? 'call' : 'put';
        }

        function extractStrike(symbol) {
            // ä»æœŸæƒåˆçº¦ç¬¦å·ä¸­æå–è¡Œæƒä»·
            if (!symbol) return 0;
            const match = symbol.match(/(\d+\.?\d*)/);
            return match ? parseFloat(match[1]) : 0;
        }

        function extractExpiry(symbol) {
            // ä»æœŸæƒåˆçº¦ç¬¦å·ä¸­æå–åˆ°æœŸæ—¥
            if (!symbol) return '';
            const match = symbol.match(/(\d{6})/);
            if (match) {
                const dateStr = match[1];
                const year = '20' + dateStr.substring(0, 2);
                const month = dateStr.substring(2, 4);
                const day = dateStr.substring(4, 6);
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        function showLoading(message = 'ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...') {
            const loadingElement = document.getElementById('loadingMessage');
            loadingElement.innerHTML = `<h3>${message}</h3>`;
            loadingElement.style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

        // ç”ŸæˆTradingViewè­¦æŠ¥æ¶ˆæ¯
        function generateAlertMessage() {
            const selectedAccount = document.getElementById('accountSelect').value;
            if (!selectedAccount) {
                showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè´¦æˆ·');
                return null;
            }

            const tvId = Math.floor(Math.random() * 2147483647) + 1;

            const template = `{
  "account_name": "${selectedAccount}",
  "signal_id": "{{strategy.order.id}}",
  "symbol": "{{ticker}}",
  "action": "{{strategy.order.action}}",
  "quantity": {{plot("quantity")}},
  "price": {{close}},
  "order_type": "{{strategy.order.type}}",
  "strategy": "{{strategy.order.comment}}",
  "timestamp": "{{timenow}}",
  "tv_id": ${tvId}
}`;

            return template;
        }

        function showAlertModal() {
            const alertMessage = generateAlertMessage();
            if (!alertMessage) return;

            alert(`TradingViewè­¦æŠ¥æ¶ˆæ¯æ¨¡æ¿å·²ç”Ÿæˆï¼š\n\n${alertMessage}\n\nè¯·å¤åˆ¶æ­¤æ¶ˆæ¯åˆ°TradingViewè­¦æŠ¥ä¸­ä½¿ç”¨ã€‚`);

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(alertMessage).then(() => {
                showSuccess('è­¦æŠ¥æ¶ˆæ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                console.warn('æ— æ³•è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
    </script>
</body>
</html>
