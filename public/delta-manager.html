<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeltaÁÆ°ÁêÜÂô® - TigerÊúüÊùÉ‰∫§Êòì</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÖ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÖ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .account-selector {
            margin: 20px 0;
        }

        .account-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ff7b00;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(255, 123, 0, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ff7b00;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #333;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #fff3e0;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #ff7b00;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-info {
            background: #ff7b00;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .delta-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .delta-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .action-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-buy {
            background: #27ae60;
            color: white;
        }

        .action-sell {
            background: #e74c3c;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ff7b00;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 123, 0, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #ff9500;
        }

        #copyAlertBtn {
            background: linear-gradient(135deg, #ff7b00 0%, #ff9500 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 123, 0, 0.3);
        }

        #copyAlertBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 123, 0, 0.4);
            background: linear-gradient(135deg, #e66a00 0%, #e68500 100%);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ÂºïÂÖ• axios Â∫ì -->
    <script>
        const cdnUrls = [
            'https://unpkg.com/axios@1.6.0/dist/axios.min.js',
            'https://cdn.bootcdn.net/ajax/libs/axios/1.6.0/axios.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js'
        ];

        let currentCdnIndex = 0;

        function loadAxios() {
            if (currentCdnIndex >= cdnUrls.length) {
                console.error('ÊâÄÊúâ axios CDN ÈÉΩÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî® fetch ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à');
                return;
            }

            const script = document.createElement('script');
            script.src = cdnUrls[currentCdnIndex];
            script.onload = function() {
                console.log(`axios Âä†ËΩΩÊàêÂäüÔºå‰ΩøÁî® CDN: ${cdnUrls[currentCdnIndex]}`);
            };
            script.onerror = function() {
                console.warn(`CDN Âä†ËΩΩÂ§±Ë¥•: ${cdnUrls[currentCdnIndex]}`);
                currentCdnIndex++;
                loadAxios();
            };
            document.head.appendChild(script);
        }

        loadAxios();
    </script>

    <div class="container">
        <div class="header">
            <h1>üêÖ DeltaÁÆ°ÁêÜÂô®</h1>
            <p>TigerÊúüÊùÉ‰ªì‰ΩçÂíåËÆ¢ÂçïDeltaÁÆ°ÁêÜ</p>

            <div class="account-selector">
                <label for="accountSelect" style="margin-right: 10px;">ÈÄâÊã©Ë¥¶Êà∑:</label>
                <select id="accountSelect">
                    <option value="">ËØ∑ÈÄâÊã©Ë¥¶Êà∑...</option>
                </select>

                <button id="copyAlertBtn" class="btn btn-info" style="margin-left: 20px;" title="Â§çÂà∂TradingViewË≠¶Êä•Ê∂àÊÅØÊ®°Êùø">
                    üìã Â§çÂà∂Ë≠¶Êä•Ê∂àÊÅØ
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="loadingMessage" class="loading">
                <h3>üîÑ Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</h3>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="successMessage" class="success" style="display: none;"></div>

            <div id="mainContent" style="display: none;">
                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ÊÄªDelta</h3>
                        <div class="value" id="totalDelta">0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>‰ªì‰ΩçDelta</h3>
                        <div class="value" id="positionDelta">0.00</div>
                        <div class="stat-subtitle" id="positionCount">0‰∏™‰ªì‰Ωç</div>
                    </div>
                    <div class="stat-card">
                        <h3>ËÆ¢ÂçïÊï∞Èáè</h3>
                        <div class="value" id="orderCount">0</div>
                        <div class="stat-subtitle">ËÆ¢ÂçïÊó†DeltaÂÄº</div>
                    </div>
                    <div class="stat-card">
                        <h3>Ë¥¶Êà∑‰ΩôÈ¢ù</h3>
                        <div class="value" id="accountBalance">$0.00</div>
                        <div class="stat-subtitle" id="availableFunds">ÂèØÁî®: $0.00</div>
                    </div>
                </div>

                <!-- ÂÆûÈôÖ‰ªì‰Ωç -->
                <div class="section">
                    <div class="section-title">
                        üè¶ ÂÆûÈôÖÊúüÊùÉ‰ªì‰Ωç
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-positions" id="refreshPositionsBtn">
                                üîÑ Âà∑Êñ∞‰ªì‰Ωç
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionsTable">
                            <thead>
                                <tr>
                                    <th>ÊúüÊùÉÂêàÁ∫¶</th>
                                    <th>Ê†áÁöÑ</th>
                                    <th>Á±ªÂûã</th>
                                    <th>Ë°åÊùÉ‰ª∑</th>
                                    <th>Âà∞ÊúüÊó•</th>
                                    <th>Êï∞Èáè</th>
                                    <th>Âπ≥Âùá‰ª∑Ê†º</th>
                                    <th>ÂΩìÂâç‰ª∑Ê†º</th>
                                    <th>DeltaÂÄº</th>
                                    <th>Áõà‰∫è</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Êú™Êàê‰∫§ËÆ¢Âçï -->
                <div class="section">
                    <div class="section-title">
                        üìã Êú™Êàê‰∫§ÊúüÊùÉËÆ¢Âçï
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-orders" id="refreshOrdersBtn">
                                üîÑ Âà∑Êñ∞ËÆ¢Âçï
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>ËÆ¢ÂçïID</th>
                                    <th>ÊúüÊùÉÂêàÁ∫¶</th>
                                    <th>Ê†áÁöÑ</th>
                                    <th>Á±ªÂûã</th>
                                    <th>ÊñπÂêë</th>
                                    <th>Êï∞Èáè</th>
                                    <th>‰ª∑Ê†º</th>
                                    <th>ËÆ¢ÂçïÁ±ªÂûã</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ‰∫§ÊòìËÆ∞ÂΩï -->
                <div class="section">
                    <div class="section-title">
                        üìä ÊúÄËøë‰∫§ÊòìËÆ∞ÂΩï
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-trades" id="refreshTradesBtn">
                                üîÑ Âà∑Êñ∞ËÆ∞ÂΩï
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tradesTable">
                            <thead>
                                <tr>
                                    <th>‰∫§ÊòìÊó∂Èó¥</th>
                                    <th>ÊúüÊùÉÂêàÁ∫¶</th>
                                    <th>Ê†áÁöÑ</th>
                                    <th>ÊñπÂêë</th>
                                    <th>Êï∞Èáè</th>
                                    <th>Êàê‰∫§‰ª∑Ê†º</th>
                                    <th>ÊâãÁª≠Ë¥π</th>
                                    <th>Áõà‰∫è</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Âà∑Êñ∞ÊåâÈíÆ -->
    <button class="refresh-btn" data-action="load-data" title="Âà∑Êñ∞Êï∞ÊçÆ">
        üîÑ
    </button>

    <script>
        // ÂàõÂª∫Áªü‰∏ÄÁöÑ HTTP ÂÆ¢Êà∑Á´Ø
        const httpClient = {
            async get(url) {
                if (typeof axios !== 'undefined') {
                    return await axios.get(url);
                } else {
                    console.warn('axios Êú™Âä†ËΩΩÔºå‰ΩøÁî® fetch Â§áÁî®ÊñπÊ°à');
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async post(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.post(url, data);
                } else {
                    console.warn('axios Êú™Âä†ËΩΩÔºå‰ΩøÁî® fetch Â§áÁî®ÊñπÊ°à');
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            }
        };

        // ÈÖçÁΩÆaxios
        setTimeout(() => {
            if (typeof axios !== 'undefined') {
                axios.defaults.timeout = 30000;
                axios.defaults.headers.common['Content-Type'] = 'application/json';

                axios.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response) {
                            let message = error.response.data?.message || `HTTP ${error.response.status}: ${error.response.statusText}`;
                            if (error.response.status === 404 && message.includes('Account not found')) {
                                const accountName = message.split(': ')[1];
                                message = `Ë¥¶Êà∑ "${accountName}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`;
                            }
                            throw new Error(message);
                        } else if (error.request) {
                            throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊúçÂä°Âô®Áä∂ÊÄÅ');
                        } else {
                            throw new Error(error.message);
                        }
                    }
                );
                console.log('axios ÈÖçÁΩÆÂÆåÊàê');
            }
        }, 1000);

        // ÂÖ®Â±ÄÂèòÈáè
        let currentAccount = '';
        let positions = [];
        let orders = [];
        let trades = [];
        let availableAccounts = [];

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading('Ê≠£Âú®ÂàùÂßãÂåñË¥¶Êà∑ÂàóË°®...');
            await loadAccounts();

            // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñË¥¶Êà∑ID
            const urlParams = new URLSearchParams(window.location.search);
            const accountId = urlParams.get('account');
            if (accountId) {
                if (availableAccounts.length > 0 && availableAccounts.includes(accountId)) {
                    document.getElementById('accountSelect').value = accountId;
                    selectAccount(accountId);
                } else if (availableAccounts.length > 0) {
                    showError(`URL‰∏≠ÊåáÂÆöÁöÑË¥¶Êà∑ "${accountId}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`);
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                } else {
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                }
            }

            // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆ
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                    e.preventDefault();
                    if (currentAccount) {
                        loadData();
                    }
                }
            });

            // Áªü‰∏ÄÁöÑ‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂô®
            document.addEventListener('click', function(e) {
                const target = e.target;
                const action = target.getAttribute('data-action');

                if (!action) return;

                console.log('üéØ Ê£ÄÊµãÂà∞ÊåâÈíÆÁÇπÂáª:', action);

                try {
                    switch (action) {
                        case 'refresh-positions':
                            refreshPositions();
                            break;
                        case 'refresh-orders':
                            refreshOrders();
                            break;
                        case 'refresh-trades':
                            refreshTrades();
                            break;
                        case 'load-data':
                            loadData();
                            break;
                        case 'cancel-order':
                            const orderId = target.getAttribute('data-order-id');
                            cancelOrder(orderId);
                            break;
                        case 'close-position':
                            const symbol = target.getAttribute('data-symbol');
                            closePosition(symbol);
                            break;
                        default:
                            console.log('‚ö†Ô∏è Êú™Áü•ÁöÑÊìç‰Ωú:', action);
                    }
                } catch (error) {
                    console.error('‚ùå ÊâßË°åÊìç‰ΩúÂ§±Ë¥•:', error);
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                }
            });

            // ÁªëÂÆöÂ§çÂà∂Ë≠¶Êä•Ê∂àÊÅØÊåâÈíÆ
            const copyAlertBtn = document.getElementById('copyAlertBtn');
            if (copyAlertBtn) {
                copyAlertBtn.addEventListener('click', showAlertModal);
            }
        });

        // Âä†ËΩΩË¥¶Êà∑ÂàóË°®
        async function loadAccounts() {
            try {
                const response = await httpClient.get('/api/accounts');
                const data = response.data;

                if (data.success && data.data && Array.isArray(data.data)) {
                    availableAccounts = data.data.map(acc => acc.name || acc);
                    console.log(`üìã ‰ªéAPIËé∑ÂèñÂà∞ ${availableAccounts.length} ‰∏™Ë¥¶Êà∑:`, availableAccounts);
                } else {
                    console.warn('APIÊú™ËøîÂõûaccountsÂ≠óÊÆµÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                    availableAccounts = [];
                }

                const select = document.getElementById('accountSelect');
                select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ë¥¶Êà∑...</option>';

                if (availableAccounts.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '‚ö†Ô∏è Êú™ÊâæÂà∞ÂèØÁî®Ë¥¶Êà∑';
                    option.disabled = true;
                    select.appendChild(option);
                    showError('Êú™ÊâæÂà∞ÂèØÁî®Ë¥¶Êà∑ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ÈÖçÁΩÆ');
                } else {
                    availableAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                }

                select.addEventListener('change', function() {
                    if (this.value) {
                        selectAccount(this.value);
                        const url = new URL(window.location);
                        url.searchParams.set('account', this.value);
                        window.history.pushState({}, '', url);
                    }
                });

            } catch (error) {
                showError('Âä†ËΩΩË¥¶Êà∑ÂàóË°®Â§±Ë¥•: ' + error.message);
            } finally {
                if (!currentAccount) {
                    hideLoading();
                }
            }
        }

        // ÈÄâÊã©Ë¥¶Êà∑
        function selectAccount(accountId) {
            if (!availableAccounts.includes(accountId)) {
                showError(`Ë¥¶Êà∑ "${accountId}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`);
                const url = new URL(window.location);
                url.searchParams.delete('account');
                window.history.replaceState({}, '', url);
                document.getElementById('accountSelect').value = '';
                return;
            }

            currentAccount = accountId;
            loadData();
        }

        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            showLoading();

            try {
                // Âπ∂Ë°åÂä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
                const [accountResponse, positionsResponse, ordersResponse, tradesResponse] = await Promise.all([
                    httpClient.get(`/api/accounts/${currentAccount}/summary`),
                    httpClient.get(`/api/accounts/${currentAccount}/positions`),
                    httpClient.get(`/api/accounts/${currentAccount}/orders`),
                    httpClient.get(`/api/accounts/${currentAccount}/trades`)
                ]);

                // Êõ¥Êñ∞Êï∞ÊçÆ
                const accountData = accountResponse.data;
                const positionsData = positionsResponse.data;
                const ordersData = ordersResponse.data;
                const tradesData = tradesResponse.data;

                if (accountData.success) {
                    updateAccountStats(accountData.data);
                }

                if (positionsData.success) {
                    positions = positionsData.data || [];
                    updatePositionsTable();
                }

                if (ordersData.success) {
                    orders = ordersData.data || [];
                    updateOrdersTable();
                }

                if (tradesData.success) {
                    trades = tradesData.data || [];
                    updateTradesTable();
                }

                hideLoading();
                showSuccess('Êï∞ÊçÆÂä†ËΩΩÊàêÂäü');

            } catch (error) {
                hideLoading();
                showError('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞Ë¥¶Êà∑ÁªüËÆ°‰ø°ÊÅØ
        function updateAccountStats(accountData) {
            const totalDelta = accountData.total_delta || 0;
            const positionDelta = accountData.position_delta || 0;
            const orderCount = orders.length;
            const balance = accountData.net_liquidation || accountData.total_cash || 0;
            const availableFunds = accountData.available_funds || accountData.buying_power || 0;

            document.getElementById('totalDelta').textContent = totalDelta.toFixed(4);
            document.getElementById('positionDelta').textContent = positionDelta.toFixed(4);
            document.getElementById('orderCount').textContent = orderCount;
            document.getElementById('accountBalance').textContent = `$${balance.toLocaleString()}`;
            document.getElementById('availableFunds').textContent = `ÂèØÁî®: $${availableFunds.toLocaleString()}`;

            document.getElementById('positionCount').textContent = `${positions.length}‰∏™‰ªì‰Ωç`;

            // ËÆæÁΩÆDeltaÈ¢úËâ≤
            const totalElement = document.getElementById('totalDelta');
            const positionElement = document.getElementById('positionDelta');

            totalElement.className = totalDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
            positionElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
        }

        // Êõ¥Êñ∞‰ªì‰ΩçË°®Ê†º
        function updatePositionsTable() {
            const tbody = document.querySelector('#positionsTable tbody');
            tbody.innerHTML = '';

            positions.forEach(position => {
                const row = document.createElement('tr');

                // Ëß£ÊûêÊúüÊùÉ‰ø°ÊÅØ
                const symbol = position.symbol || position.contract || '';
                const underlying = position.underlying || extractUnderlying(symbol);
                const optionType = position.option_type || extractOptionType(symbol);
                const strike = position.strike || extractStrike(symbol);
                const expiry = position.expiry || extractExpiry(symbol);
                const quantity = position.quantity || position.position || 0;
                const avgPrice = position.average_price || position.avg_price || 0;
                const currentPrice = position.market_price || position.last_price || 0;
                const delta = position.delta || 0;
                const pnl = position.unrealized_pnl || position.pnl || 0;

                row.innerHTML = `
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${optionType === 'call' ? 'action-buy' : 'action-sell'}">${optionType.toUpperCase()}</span></td>
                    <td>$${strike}</td>
                    <td>${formatDate(expiry)}</td>
                    <td>${quantity}</td>
                    <td>$${avgPrice.toFixed(2)}</td>
                    <td>$${currentPrice.toFixed(2)}</td>
                    <td class="${delta >= 0 ? 'delta-positive' : 'delta-negative'}">${delta.toFixed(4)}</td>
                    <td class="${pnl >= 0 ? 'delta-positive' : 'delta-negative'}">$${pnl.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger" data-action="close-position" data-symbol="${symbol}">Âπ≥‰ªì</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (positions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="11" style="text-align: center; color: #7f8c8d;">ÊöÇÊó†ÊúüÊùÉ‰ªì‰Ωç</td>';
                tbody.appendChild(row);
            }
        }

        // Êõ¥Êñ∞ËÆ¢ÂçïË°®Ê†º
        function updateOrdersTable() {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            orders.forEach(order => {
                const row = document.createElement('tr');

                const orderId = order.order_id || order.id || '';
                const symbol = order.symbol || order.contract || '';
                const underlying = order.underlying || extractUnderlying(symbol);
                const optionType = order.option_type || extractOptionType(symbol);
                const side = order.side || order.action || '';
                const quantity = order.quantity || order.total_quantity || 0;
                const price = order.limit_price || order.price || 0;
                const orderType = order.order_type || order.type || '';
                const status = order.status || order.order_status || '';
                const createTime = order.create_time || order.created_at || '';

                row.innerHTML = `
                    <td>${orderId}</td>
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${optionType === 'call' ? 'action-buy' : 'action-sell'}">${optionType.toUpperCase()}</span></td>
                    <td><span class="action-badge ${side === 'buy' ? 'action-buy' : 'action-sell'}">${side.toUpperCase()}</span></td>
                    <td>${quantity}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>${orderType}</td>
                    <td>${status}</td>
                    <td>${formatDateTime(createTime)}</td>
                    <td>
                        <button class="btn btn-danger" data-action="cancel-order" data-order-id="${orderId}">Êí§Âçï</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (orders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="11" style="text-align: center; color: #7f8c8d;">ÊöÇÊó†Êú™Êàê‰∫§ËÆ¢Âçï</td>';
                tbody.appendChild(row);
            }
        }

        // Êõ¥Êñ∞‰∫§ÊòìËÆ∞ÂΩïË°®Ê†º
        function updateTradesTable() {
            const tbody = document.querySelector('#tradesTable tbody');
            tbody.innerHTML = '';

            trades.slice(0, 20).forEach(trade => { // Âè™ÊòæÁ§∫ÊúÄËøë20Êù°ËÆ∞ÂΩï
                const row = document.createElement('tr');

                const tradeTime = trade.trade_time || trade.created_at || '';
                const symbol = trade.symbol || trade.contract || '';
                const underlying = trade.underlying || extractUnderlying(symbol);
                const side = trade.side || trade.action || '';
                const quantity = trade.quantity || trade.filled_quantity || 0;
                const price = trade.price || trade.fill_price || 0;
                const commission = trade.commission || trade.fee || 0;
                const pnl = trade.realized_pnl || trade.pnl || 0;

                row.innerHTML = `
                    <td>${formatDateTime(tradeTime)}</td>
                    <td>${symbol}</td>
                    <td>${underlying}</td>
                    <td><span class="action-badge ${side === 'buy' ? 'action-buy' : 'action-sell'}">${side.toUpperCase()}</span></td>
                    <td>${quantity}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>$${commission.toFixed(2)}</td>
                    <td class="${pnl >= 0 ? 'delta-positive' : 'delta-negative'}">$${pnl.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            if (trades.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #7f8c8d;">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</td>';
                tbody.appendChild(row);
            }
        }

        // Âà∑Êñ∞‰ªì‰Ωç
        async function refreshPositions() {
            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            const btn = document.getElementById('refreshPositionsBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Âà∑Êñ∞‰∏≠...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/positions`);
                if (response.data.success) {
                    positions = response.data.data || [];
                    updatePositionsTable();
                    showSuccess(`‰ªì‰ΩçÊï∞ÊçÆÂà∑Êñ∞ÊàêÂäü - ${positions.length}‰∏™‰ªì‰Ωç`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('Âà∑Êñ∞‰ªì‰ΩçÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Âà∑Êñ∞‰ªì‰Ωç';
            }
        }

        // Âà∑Êñ∞ËÆ¢Âçï
        async function refreshOrders() {
            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            const btn = document.getElementById('refreshOrdersBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Âà∑Êñ∞‰∏≠...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/orders`);
                if (response.data.success) {
                    orders = response.data.data || [];
                    updateOrdersTable();
                    showSuccess(`ËÆ¢ÂçïÊï∞ÊçÆÂà∑Êñ∞ÊàêÂäü - ${orders.length}‰∏™ËÆ¢Âçï`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('Âà∑Êñ∞ËÆ¢ÂçïÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Âà∑Êñ∞ËÆ¢Âçï';
            }
        }

        // Âà∑Êñ∞‰∫§ÊòìËÆ∞ÂΩï
        async function refreshTrades() {
            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            const btn = document.getElementById('refreshTradesBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Âà∑Êñ∞‰∏≠...';

            try {
                const response = await httpClient.get(`/api/accounts/${currentAccount}/trades`);
                if (response.data.success) {
                    trades = response.data.data || [];
                    updateTradesTable();
                    showSuccess(`‰∫§ÊòìËÆ∞ÂΩïÂà∑Êñ∞ÊàêÂäü - ${trades.length}Êù°ËÆ∞ÂΩï`);
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('Âà∑Êñ∞‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ Âà∑Êñ∞ËÆ∞ÂΩï';
            }
        }

        // Êí§ÈîÄËÆ¢Âçï
        async function cancelOrder(orderId) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÊí§ÈîÄËÆ¢Âçï ${orderId} ÂêóÔºü`)) return;

            try {
                const response = await httpClient.post(`/api/accounts/${currentAccount}/orders/${orderId}/cancel`);
                if (response.data.success) {
                    showSuccess('ËÆ¢ÂçïÊí§ÈîÄÊàêÂäü');
                    refreshOrders();
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('Êí§ÈîÄËÆ¢ÂçïÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âπ≥‰ªì
        async function closePosition(symbol) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂπ≥‰ªì ${symbol} ÂêóÔºü`)) return;

            try {
                const response = await httpClient.post(`/api/accounts/${currentAccount}/positions/${symbol}/close`);
                if (response.data.success) {
                    showSuccess('Âπ≥‰ªìÊìç‰ΩúÊàêÂäü');
                    refreshPositions();
                } else {
                    throw new Error(response.data.message);
                }
            } catch (error) {
                showError('Âπ≥‰ªìÊìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function extractUnderlying(symbol) {
            // ‰ªéÊúüÊùÉÂêàÁ∫¶Á¨¶Âè∑‰∏≠ÊèêÂèñÊ†áÁöÑËµÑ‰∫ß
            if (!symbol) return '';
            const match = symbol.match(/^([A-Z]+)/);
            return match ? match[1] : symbol.split(' ')[0] || '';
        }

        function extractOptionType(symbol) {
            // ‰ªéÊúüÊùÉÂêàÁ∫¶Á¨¶Âè∑‰∏≠ÊèêÂèñÊúüÊùÉÁ±ªÂûã
            if (!symbol) return '';
            return symbol.includes('C') || symbol.toLowerCase().includes('call') ? 'call' : 'put';
        }

        function extractStrike(symbol) {
            // ‰ªéÊúüÊùÉÂêàÁ∫¶Á¨¶Âè∑‰∏≠ÊèêÂèñË°åÊùÉ‰ª∑
            if (!symbol) return 0;
            const match = symbol.match(/(\d+\.?\d*)/);
            return match ? parseFloat(match[1]) : 0;
        }

        function extractExpiry(symbol) {
            // ‰ªéÊúüÊùÉÂêàÁ∫¶Á¨¶Âè∑‰∏≠ÊèêÂèñÂà∞ÊúüÊó•
            if (!symbol) return '';
            const match = symbol.match(/(\d{6})/);
            if (match) {
                const dateStr = match[1];
                const year = '20' + dateStr.substring(0, 2);
                const month = dateStr.substring(2, 4);
                const day = dateStr.substring(4, 6);
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateStr;
            }
        }

        function showLoading(message = 'üîÑ Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...') {
            const loadingElement = document.getElementById('loadingMessage');
            loadingElement.innerHTML = `<h3>${message}</h3>`;
            loadingElement.style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

        // ÁîüÊàêTradingViewË≠¶Êä•Ê∂àÊÅØ
        function generateAlertMessage() {
            const selectedAccount = document.getElementById('accountSelect').value;
            if (!selectedAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ë¥¶Êà∑');
                return null;
            }

            const tvId = Math.floor(Math.random() * 2147483647) + 1;

            const template = `{
  "account_name": "${selectedAccount}",
  "signal_id": "{{strategy.order.id}}",
  "symbol": "{{ticker}}",
  "action": "{{strategy.order.action}}",
  "quantity": {{plot("quantity")}},
  "price": {{close}},
  "order_type": "{{strategy.order.type}}",
  "strategy": "{{strategy.order.comment}}",
  "timestamp": "{{timenow}}",
  "tv_id": ${tvId}
}`;

            return template;
        }

        function showAlertModal() {
            const alertMessage = generateAlertMessage();
            if (!alertMessage) return;

            alert(`TradingViewË≠¶Êä•Ê∂àÊÅØÊ®°ÊùøÂ∑≤ÁîüÊàêÔºö\n\n${alertMessage}\n\nËØ∑Â§çÂà∂Ê≠§Ê∂àÊÅØÂà∞TradingViewË≠¶Êä•‰∏≠‰ΩøÁî®„ÄÇ`);

            // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            navigator.clipboard.writeText(alertMessage).then(() => {
                showSuccess('Ë≠¶Êä•Ê∂àÊÅØÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            }).catch(() => {
                console.warn('Êó†Ê≥ïËá™Âä®Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            });
        }
    </script>
</body>
</html>
